<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>LEO CONNECT PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/socket.io/socket.io.js"></script>

<style>
:root{
  --neon:#00f2ff;
  --bg:#020617;
  --glass:rgba(255,255,255,0.12);
}
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{
  margin:0;
  background:radial-gradient(circle at top,#020617,#000);
  color:#fff;
  min-height:100vh;
}

/* ---------- LOGIN (IMAGE STYLE) ---------- */
#lobby{
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.login-card{
  width:90%;
  max-width:360px;
  padding:30px;
  border-radius:26px;
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.05));
  backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,.2);
}
.login-card h1{
  text-align:center;
  margin-bottom:20px;
  font-size:1.8rem;
  background:linear-gradient(90deg,var(--neon),#fff,var(--neon));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
input{
  width:100%;
  padding:14px;
  margin-bottom:12px;
  border-radius:14px;
  border:1px solid #1e3a8a;
  background:#0007;
  color:#fff;
}
.join{
  width:100%;
  padding:14px;
  border-radius:16px;
  background:var(--neon);
  color:#000;
  font-weight:bold;
  border:none;
}

/* ---------- CALL ---------- */
#call{
  display:none;
  position:relative;
  height:100vh;
  overflow:hidden;
}

/* MAIN VIDEO (CENTER GLASS CARD) */
#main-video{
  position:absolute;
  inset:60px 20px 140px 20px;
  border-radius:28px;
  overflow:hidden;
  background:#000;
  box-shadow:0 30px 80px #000;
}
#main-video video{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* FLOATING BUBBLES */
#bubbles{
  position:absolute;
  bottom:120px;
  left:0;
  right:0;
  display:flex;
  justify-content:center;
  gap:14px;
}
.bubble{
  width:76px;
  height:76px;
  border-radius:50%;
  overflow:hidden;
  background:#000;
  border:2px solid rgba(255,255,255,.4);
}
.bubble video{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* NAME TAG */
.name{
  position:absolute;
  bottom:10px;
  left:10px;
  padding:4px 10px;
  border-radius:10px;
  background:#0008;
  font-size:.75rem;
}

/* BOTTOM BAR (IMAGE STYLE) */
.controls{
  position:absolute;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:16px;
  padding:14px 26px;
  border-radius:50px;
  background:#000c;
  backdrop-filter:blur(14px);
}
.ctrl{
  width:52px;
  height:52px;
  border-radius:50%;
  background:var(--glass);
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:1.3rem;
  border:none;
  color:#fff;
}
.end{background:#ef4444}

/* CHAT (IMAGE STYLE) */
#chat{
  position:absolute;
  top:0;
  right:0;
  width:85%;
  max-width:340px;
  height:100%;
  background:#020617f0;
  backdrop-filter:blur(16px);
  transform:translateX(100%);
  transition:.35s;
  display:flex;
  flex-direction:column;
}
#chat.show{transform:translateX(0)}
.chat-head{
  padding:16px;
  display:flex;
  justify-content:space-between;
  border-bottom:1px solid #ffffff22;
}
.chat-body{
  flex:1;
  padding:14px;
  overflow:auto;
}
.msg{
  padding:8px 12px;
  border-radius:12px;
  margin-bottom:10px;
  max-width:80%;
}
.other{background:#ffffff22}
.me{background:var(--neon);color:#000;margin-left:auto}
.chat-input{
  display:flex;
  gap:8px;
  padding:12px;
  border-top:1px solid #ffffff22;
}
.chat-input input{flex:1}
.chat-input button{background:#555;color:#999;border:none;border-radius:8px}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="lobby">
  <div class="login-card">
    <h1>LEO CONNECT</h1>
    <input id="name" placeholder="Your Name">
    <input id="room" placeholder="Room ID">
    <button class="join" onclick="start()">JOIN SESSION</button>
  </div>
</div>

<!-- CALL -->
<div id="call">
  <div id="main-video"></div>
  <div id="bubbles"></div>

  <div class="controls">
    <button class="ctrl" onclick="toggleMic()">üé§</button>
    <button class="ctrl" onclick="switchCam()">üîÑ</button>
    <button class="ctrl" onclick="toggleChat()">üí¨</button>
    <button class="ctrl end" onclick="location.reload()">üìû</button>
  </div>

  <!-- CHAT -->
  <div id="chat">
    <div class="chat-head">
      <span>Chat</span>
      <button onclick="toggleChat()">‚úï</button>
    </div>
    <div class="chat-body">
      <div class="msg other">Jake: Can you hear me?</div>
      <div class="msg me">You: Yes üëç</div>
    </div>
    <div class="chat-input">
      <input disabled placeholder="Message...">
      <button disabled>Send</button>
    </div>
  </div>
</div>

<script>
const socket=io();
let localStream,peers={},roomId,myName,facing="user";
const config={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

async function start(){
  myName=name.value;
  roomId=room.value;
  if(!myName||!roomId)return alert("Fill details");
  lobby.style.display="none";
  call.style.display="block";

  localStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing},audio:true});
  setMain("me",localStream,myName+" (You)",true);

  socket.emit("join-room",{roomId,nickname:myName});
  socket.on("user-joined",d=>offer(d.id));
  socket.on("signal",handleSignal);
  socket.on("user-left",id=>remove(id));
}

function setMain(id,stream,label,muted){
  main-video.innerHTML="";
  const v=document.createElement("video");
  v.srcObject=stream;v.autoplay=true;v.playsInline=true;
  if(muted)v.muted=true;
  const n=document.createElement("div");
  n.className="name";n.innerText=label;
  main-video.append(v,n);
}

function addBubble(id,stream){
  if(document.getElementById("b-"+id))return;
  const b=document.createElement("div");
  b.className="bubble";b.id="b-"+id;
  const v=document.createElement("video");
  v.srcObject=stream;v.autoplay=true;v.playsInline=true;
  b.append(v);
  b.onclick=()=>setMain(id,stream,"Guest");
  bubbles.append(b);
}

function remove(id){
  peers[id]?.close();
  document.getElementById("b-"+id)?.remove();
  delete peers[id];
}

function createPC(id){
  const pc=new RTCPeerConnection(config);
  peers[id]=pc;
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.onicecandidate=e=>e.candidate&&socket.emit("signal",{to:id,signal:{candidate:e.candidate}});
  pc.ontrack=e=>addBubble(id,e.streams[0]);
  return pc;
}

async function offer(id){
  const pc=createPC(id);
  const o=await pc.createOffer();
  await pc.setLocalDescription(o);
  socket.emit("signal",{to:id,signal:{sdp:o}});
}

async function handleSignal(d){
  let pc=peers[d.from]||createPC(d.from);
  if(d.signal.sdp){
    await pc.setRemoteDescription(new RTCSessionDescription(d.signal.sdp));
    if(d.signal.sdp.type==="offer"){
      const a=await pc.createAnswer();
      await pc.setLocalDescription(a);
      socket.emit("signal",{to:d.from,signal:{sdp:a}});
    }
  }else if(d.signal.candidate){
    await pc.addIceCandidate(new RTCIceCandidate(d.signal.candidate));
  }
}

function toggleMic(){
  const t=localStream.getAudioTracks()[0];
  t.enabled=!t.enabled;
}

async function switchCam(){
  facing=facing==="user"?"environment":"user";
  localStream.getTracks().forEach(t=>t.stop());
  localStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:facing},audio:true});
  main-video.querySelector("video").srcObject=localStream;
  for(const id in peers){
    const s=peers[id].getSenders().find(x=>x.track.kind==="video");
    s&&s.replaceTrack(localStream.getVideoTracks()[0]);
  }
}

function toggleChat(){chat.classList.toggle("show")}
</script>

</body>
</html>
