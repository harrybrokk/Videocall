<!DOCTYPE html>
<html lang="en">
<head>
    <title>LEO CONNECT - PRO HUB</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/socket.io/socket.io.js"></script>

<style>
:root{
  --neon:#00f2ff;
  --bg:#030712;
  --glass:rgba(255,255,255,0.12);
}
*{box-sizing:border-box;font-family:'Segoe UI',sans-serif}
body{
  margin:0;
  background:radial-gradient(circle at top,#020617,#000);
  color:#fff;
  min-height:100vh;
}

/* ---------- TITLE ---------- */
.shiny-title{
  text-align:center;
  font-size:2rem;
  font-weight:800;
  margin:20px 0;
  background:linear-gradient(90deg,var(--neon),#fff,var(--neon));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

/* ---------- LOBBY ---------- */
#lobby{
  height:80vh;
  display:flex;
  justify-content:center;
  align-items:center;
}
.glass-card{
  width:90%;
  max-width:380px;
  padding:30px;
  border-radius:26px;
  background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.05));
  backdrop-filter:blur(18px);
  border:1px solid rgba(255,255,255,.2);
  text-align:center;
}
input{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:14px;
  border:1px solid #1e3a8a;
  background:#0007;
  color:#fff;
}
.btn-join{
  width:100%;
  padding:14px;
  margin-top:15px;
  border-radius:16px;
  background:var(--neon);
  color:#000;
  font-weight:bold;
  border:none;
}

/* ---------- CALL ROOM ---------- */
#call-room{
  display:none;
  height:100vh;
  position:relative;
  padding:10px;
}

/* MAIN VIDEO (FIRST CHILD) */
#video-grid{
  position:absolute;
  inset:70px 20px 150px 20px;
}
#video-grid .video-container:first-child{
  width:100%;
  height:100%;
  border-radius:28px;
  overflow:hidden;
}

/* FLOATING BUBBLES */
#video-grid .video-container:not(:first-child){
  position:absolute;
  bottom:-110px;
  width:80px;
  height:80px;
  border-radius:50%;
  overflow:hidden;
  border:2px solid rgba(255,255,255,.4);
}
#video-grid .video-container:nth-child(2){left:20%}
#video-grid .video-container:nth-child(3){left:45%}
#video-grid .video-container:nth-child(4){left:70%}

.video-container{
  background:#000;
  position:relative;
}
video{
  width:100%;
  height:100%;
  object-fit:cover;
}
.name-tag{
  position:absolute;
  bottom:10px;
  left:10px;
  background:#0008;
  padding:4px 10px;
  border-radius:10px;
  font-size:.75rem;
}

/* ---------- LOCAL CONTROLS ---------- */
.vid-controls{
  position:absolute;
  top:10px;
  right:10px;
  display:flex;
  gap:6px;
}
.small-btn{
  font-size:.6rem;
  padding:4px 8px;
  border-radius:8px;
  background:#0008;
  color:#fff;
  border:1px solid var(--neon);
}

/* ---------- BOTTOM BAR ---------- */
.bottom-controls{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:16px;
  padding:14px 26px;
  border-radius:50px;
  background:#000c;
  backdrop-filter:blur(14px);
  border:1px solid rgba(255,255,255,.2);
}
.main-icon-btn{
  width:52px;
  height:52px;
  border-radius:50%;
  background:var(--glass);
  color:#fff;
  border:none;
  font-size:1.2rem;
}
.hidden{display:none!important}
</style>
</head>

<body>

<div class="shiny-title">LEO CONNECT PRO</div>

<!-- LOBBY -->
<div id="lobby">
  <div class="glass-card">
    <input id="nickname" placeholder="Your Name">
    <input id="roomid" placeholder="Room ID">
    <button class="btn-join" onclick="initCall()">JOIN SESSION</button>
  </div>
</div>

<!-- CALL ROOM -->
<div id="call-room">
  <div id="video-grid">
    <!-- LOCAL VIDEO (UNCHANGED) -->
    <div class="video-container">
      <div class="vid-controls">
        <button class="small-btn" onclick="switchCamera('user')">FRONT</button>
        <button class="small-btn" onclick="switchCamera('environment')">BACK</button>
        <button class="small-btn" id="localMicBtn" onclick="toggleMic()">ðŸŽ¤ ON</button>
      </div>
      <video id="localVideo" autoplay playsinline muted></video>
      <div class="name-tag" id="myTag">You</div>
    </div>
  </div>

  <div class="bottom-controls">
    <button class="main-icon-btn" style="background:#ef4444" onclick="location.reload()">ðŸ“ž</button>
    <button class="main-icon-btn" style="background:#7f1d1d" onclick="dismissAll()">ðŸ’€</button>
  </div>
</div>

<!-- ===== ORIGINAL JS (UNCHANGED) ===== -->
<script>
const socket = io();
let myStream, pcList = {}, myNickname, myRoom;
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

async function initCall() {
  myNickname = nickname.value;
  myRoom = roomid.value;
  if(!myNickname || !myRoom) return alert("Fill details!");

  lobby.classList.add("hidden");
  document.getElementById("call-room").style.display="block";
  myTag.innerText = myNickname + " (Me)";

  myStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"}, audio:true });
  localVideo.srcObject = myStream;

  socket.emit("join-room",{roomId:myRoom,nickname:myNickname});
  socket.on("user-joined",d=>sendOffer(d.id));
  socket.on("signal",d=>handleSignal(d));
  socket.on("user-left",id=>{
    pcList[id]?.close();
    document.getElementById(id)?.remove();
    delete pcList[id];
  });
}

async function switchCamera(mode){
  const muted=!myStream.getAudioTracks()[0].enabled;
  myStream.getTracks().forEach(t=>t.stop());
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:mode},audio:true});
  localVideo.srcObject=s;
  s.getAudioTracks()[0].enabled=!muted;
  for(const id in pcList){
    const sender=pcList[id].getSenders().find(x=>x.track.kind==="video");
    sender&&sender.replaceTrack(s.getVideoTracks()[0]);
  }
  myStream=s;
}

function toggleMic(){
  const t=myStream.getAudioTracks()[0];
  t.enabled=!t.enabled;
  localMicBtn.innerText=t.enabled?"ðŸŽ¤ ON":"ðŸ”‡ OFF";
}

function createPC(id){
  const pc=new RTCPeerConnection(config);
  pcList[id]=pc;
  myStream.getTracks().forEach(t=>pc.addTrack(t,myStream));
  pc.onicecandidate=e=>e.candidate&&socket.emit("signal",{to:id,signal:{candidate:e.candidate}});
  pc.ontrack=e=>showRemoteVideo(id,e.streams[0]);
  return pc;
}

async function sendOffer(id){
  const pc=createPC(id);
  const o=await pc.createOffer();
  await pc.setLocalDescription(o);
  socket.emit("signal",{to:id,signal:{sdp:o},nickname:myNickname});
}

async function handleSignal(d){
  let pc=pcList[d.from]||createPC(d.from);
  if(d.signal.sdp){
    await pc.setRemoteDescription(new RTCSessionDescription(d.signal.sdp));
    if(d.signal.sdp.type==="offer"){
      const a=await pc.createAnswer();
      await pc.setLocalDescription(a);
      socket.emit("signal",{to:d.from,signal:{sdp:a},nickname:myNickname});
    }
  }else if(d.signal.candidate){
    await pc.addIceCandidate(new RTCIceCandidate(d.signal.candidate));
  }
}

function showRemoteVideo(id,stream){
  if(document.getElementById(id))return;
  const d=document.createElement("div");
  d.className="video-container";
  d.id=id;
  const v=document.createElement("video");
  v.srcObject=stream;v.autoplay=true;v.playsInline=true;
  const n=document.createElement("div");
  n.className="name-tag";n.innerText="Guest";
  d.append(v,n);
  video-grid.append(d);
}

function dismissAll(){
  if(confirm("End room?")) socket.emit("dismiss-room",myRoom);
}
</script>
</body>
</html>
