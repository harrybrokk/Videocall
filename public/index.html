<!DOCTYPE html>
<html>
<head>
    <title>LEO CONNECT - ADAPTIVE GRID PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { 
            --neon: #00f2ff; 
            --dark: #010409; 
            --panel: #0a192f;
            --input-focus: #ffc400; /* Yellow Neon for Input */
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--dark); color: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }

        /* Background & Title */
        .background { position: fixed; inset: 0; background: radial-gradient(circle at center, #0f172a 0%, #010409 100%); z-index: -1; }
        .grid-lines {
            position: absolute; width: 200%; height: 200%;
            background-image: linear-gradient(rgba(0,242,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,242,255,0.1) 1px, transparent 1px); /* Light Neon Glow Grid */
            background-size: 50px 50px; transform: perspective(500px) rotateX(60deg);
            top: -50%; left: -50%; animation: moveGrid 15s linear infinite; opacity: 0.25;
        }
        @keyframes moveGrid { from { transform: perspective(500px) rotateX(60deg) translateY(0); } to { transform: perspective(500px) rotateX(60deg) translateY(50px); } }
        .shiny-title { /* ... (Same as before) */ }

        /* LOBBY UI */
        #lobby { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; z-index: 10; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 35px; border-radius: 30px; text-align: center; width: 85%; max-width: 360px; box-shadow: 0 20px 50px rgba(0,0,0,0.7); }
        input { 
            width: 100%; padding: 14px; margin: 10px 0; background: rgba(0,0,0,0.5); 
            border: 1px solid #1e3a8a; border-radius: 12px; color: #fff; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--input-focus); box-shadow: 0 0 10px rgba(255, 196, 0, 0.5); }
        .btn-join { width: 100%; padding: 16px; margin-top: 20px; background: var(--neon); color: #000; border: none; border-radius: 50px; font-weight: 800; cursor: pointer; box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); transition: 0.3s; }

        /* ADAPTIVE RECTANGULAR GRID */
        #call-room { display: none; width: 100%; height: 100%; padding: 10px; flex-direction: column; align-items: center; z-index: 5; }
        #video-grid { 
            display: grid; 
            width: 100%; height: 90vh;
            gap: 5px; 
            margin-top: 5px;
            /* Adaptive Grid will be set by JS */
        }
        
        .video-container { 
            position: relative; border-radius: 10px; overflow: hidden; 
            background: #111; border: 2px solid var(--neon);
            box-shadow: 0 0 15px rgba(0,242,255,0.2); transition: 0.4s ease;
        }
        
        /* FULL IMAGE FIX */
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* FLOATING COMMAND DOCK */
        .controls { 
            position: fixed; bottom: 15px; display: flex; gap: 15px; 
            background: rgba(10, 25, 47, 0.8); padding: 10px 20px; border-radius: 40px;
            backdrop-filter: blur(15px); border: 1px solid var(--neon);
        }
        .btn-orb { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
        .btn-orb:active { background: var(--neon) !important; color: var(--dark) !important; transform: scale(0.9); }
        .btn-orb.red { color: #ff4444; border-color: #ff4444; }

        /* IN-VIDEO BUTTONS */
        .vid-controls { 
            position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .vid-controls.show { opacity: 1; pointer-events: auto; }
        .small-btn { 
            background: rgba(0, 0, 0, 0.4); color: var(--neon); border: 1px solid var(--neon); 
            padding: 4px 8px; border-radius: 5px; font-size: 0.6rem; font-weight: bold; cursor: pointer;
            transition: 0.1s;
        }
        .small-btn:active { background: var(--neon); color: var(--dark); } /* Click Feedback Fix */

        .name-tag { position: absolute; bottom: 8px; left: 10px; background: rgba(0, 0, 0, 0.7); padding: 2px 10px; border-radius: 10px; font-size: 0.65rem; border: 1px solid var(--neon); color: #fff; z-index: 10; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="background"><div class="grid-lines"></div></div>
    <div class="shiny-title">LEO CONNECT PRO</div>

    <div id="lobby">
        <div class="glass-card">
            <h3 style="margin:0 0 20px 0; font-weight:400; font-size: 0.9rem; letter-spacing:1px;">HUB ACCESS</h3>
            <input type="text" id="nickname" placeholder="Commander Name">
            <input type="text" id="roomid" placeholder="Secure Room ID">
            <button class="btn-join" onclick="initCall()">AUTHORIZE & JOIN</button>
        </div>
    </div>

    <div id="call-room">
        <div id="video-grid">
            <!-- Local User Box -->
        </div>

        <div class="controls">
            <button class="btn-orb" id="micBtn" onclick="toggleMic()">ðŸŽ¤</button>
            <button class="btn-orb" onclick="location.reload()">ðŸ“ž</button>
            <button class="btn-orb red" onclick="dismissAll()" title="End Session">ðŸš«</button>
        </div>
    </div>

    <script>
        const socket = io();
        const videoGrid = document.getElementById('video-grid');
        let myStream, pcList = {}, myNickname, myRoom;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let controlTimeout;

        function updateGridStyles() {
            const count = videoGrid.children.length;
            let template = '';
            let height = '100%';

            if (count === 1) {
                template = '1fr';
            } else if (count === 2) {
                template = '1fr';
                videoGrid.style.gridTemplateRows = '1fr 1fr';
                videoGrid.style.gridTemplateColumns = '1fr';
            } else if (count === 3) {
                template = '1fr 1fr'; // Top two, bottom one takes full row
                videoGrid.style.gridTemplateRows = '1fr 1fr 1fr';
                // JS will handle the 3-box layout
            } else if (count >= 4) {
                template = '1fr 1fr';
                videoGrid.style.gridTemplateRows = '1fr 1fr';
                videoGrid.style.gridTemplateColumns = '1fr 1fr';
            }
            
            if (count === 1 || count === 2) {
                videoGrid.style.gridTemplateColumns = '1fr';
            } else if (count === 3) {
                videoGrid.style.gridTemplateColumns = '1fr 1fr';
            }
        }

        const resizeObserver = new ResizeObserver(() => {
            updateGridStyles();
        });
        resizeObserver.observe(videoGrid);

        async function initCall() {
            myNickname = document.getElementById('nickname').value;
            myRoom = document.getElementById('roomid').value;
            if(!myNickname || !myRoom) return alert("Fill Authorization!");

            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('call-room').style.display = 'flex';

            myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
            
            // Add local video to grid
            addLocalVideo();

            socket.emit('join-room', { roomId: myRoom, nickname: myNickname });
            socket.on('user-joined', (data) => sendOffer(data.id));
            socket.on('signal', (data) => handleSignal(data));
            socket.on('room-dismissed', () => { alert("Hub Closed"); location.reload(); });
            socket.on('user-left', (id) => { 
                if(pcList[id]) { 
                    pcList[id].close(); 
                    document.getElementById(id)?.remove(); 
                    delete pcList[id];
                    updateGridStyles();
                } 
            });
        }
        
        function addLocalVideo() {
            const container = createVideoContainer('local');
            container.classList.add('is-local');
            container.onclick = function() { toggleOrbControls(this); };

            container.innerHTML = `
                <div class="vid-controls">
                    <button class="small-btn" onclick="switchCamera('user')">FRONT CAM</button>
                    <button class="small-btn" onclick="switchCamera('environment')">BACK CAM</button>
                </div>
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="name-tag">${myNickname} (You)</div>
            `;
            document.getElementById('localVideo').srcObject = myStream;
            videoGrid.appendChild(container);
            updateGridStyles();
        }

        // Tap to show controls and auto-hide
        function toggleOrbControls(el) {
            const controls = el.querySelector('.vid-controls');
            if (controlTimeout) clearTimeout(controlTimeout);
            controls.classList.add('show');
            controlTimeout = setTimeout(() => { controls.classList.remove('show'); }, 3000);
        }

        // --- CAMERA SWITCH FIX ---
        async function switchCamera(mode) {
            if(myStream) myStream.getTracks().forEach(t => t.stop());
            
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode }, audio: true });
                const newVT = newStream.getVideoTracks()[0];
                const newAT = newStream.getAudioTracks()[0];
                const isMuted = !myStream.getAudioTracks()[0].enabled;
                
                // Update Local UI
                document.getElementById('localVideo').srcObject = newStream;

                // Replace Tracks for all Peers
                for(let id in pcList) {
                    const senders = pcList[id].getSenders();
                    const vSender = senders.find(s => s.track && s.track.kind === 'video');
                    const aSender = senders.find(s => s.track && s.track.kind === 'audio');
                    if(vSender) await vSender.replaceTrack(newVT);
                    if(aSender) await aSender.replaceTrack(newAT);
                }

                newStream.getAudioTracks()[0].enabled = !isMuted;
                myStream = newStream;

                // Auto-hide controls after successful switch
                const localOrb = document.querySelector('.is-local');
                localOrb.querySelector('.vid-controls').classList.remove('show');

            } catch(e) { alert("Camera Busy"); }
        }

        // ... (Baaki functions - toggleMic, createPC, sendOffer, handleSignal, dismissAll - wahi rahenge)
    </script>
</body>
</html>
