<!DOCTYPE html>
<html>
<head>
    <title>LEO CONNECT - ADAPTIVE GRID FIX</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --neon: #00f2ff; --dark: #010409; --panel: #0a192f; }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--dark); color: #fff; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; align-items: center; }

        /* HOLOGRID BACKGROUND & TITLE */
        .background { position: fixed; inset: 0; background: radial-gradient(circle at center, #0f172a 0%, #010409 100%); z-index: -1; }
        .grid-lines { position: absolute; width: 200%; height: 200%; background-image: linear-gradient(rgba(0,242,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0,242,255,0.1) 1px, transparent 1px); background-size: 50px 50px; transform: perspective(500px) rotateX(60deg); top: -50%; left: -50%; animation: moveGrid 15s linear infinite; opacity: 0.25; }
        @keyframes moveGrid { from { transform: perspective(500px) rotateX(60deg) translateY(0); } to { transform: perspective(500px) rotateX(60deg) translateY(50px); } }
        .shiny-title { font-size: 1.6rem; font-weight: 900; text-align: center; background: linear-gradient(to right, #00f2ff, #fff, #00f2ff); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 4s linear infinite; letter-spacing: 3px; margin-top: 15px; z-index: 10; }
        @keyframes shine { to { background-position: 200% center; } }

        /* LOBBY UI */
        #lobby { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; z-index: 10; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 35px; border-radius: 30px; text-align: center; width: 85%; max-width: 360px; }
        input { width: 100%; padding: 14px; margin: 10px 0; background: rgba(0,0,0,0.5); border: 1px solid #1e3a8a; border-radius: 12px; color: #fff; outline: none; transition: 0.3s; }
        .btn-join { width: 100%; padding: 16px; margin-top: 20px; background: var(--neon); color: #000; border: none; border-radius: 50px; font-weight: 800; cursor: pointer; box-shadow: 0 0 20px rgba(0, 242, 255, 0.3); }

        /* ADAPTIVE RECTANGULAR GRID */
        #call-room { display: none; width: 100%; height: 100%; padding: 10px; flex-direction: column; align-items: center; z-index: 5; }
        #video-grid { 
            display: grid; width: 100%; height: 90vh; gap: 8px; margin-top: 5px;
            /* Grid Template will be set by JS */
        }
        
        .video-container { 
            position: relative; border-radius: 10px; overflow: hidden; 
            background: #111; border: 2px solid var(--neon);
            box-shadow: 0 0 15px rgba(0,242,255,0.2); transition: 0.4s ease;
        }
        
        /* FULL IMAGE IN RECTANGLE FIX */
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* FLOATING CONTROLS */
        .vid-controls { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 10; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        .vid-controls.show { opacity: 1; pointer-events: auto; }
        .small-btn { 
            background: rgba(0, 0, 0, 0.4); color: var(--neon); border: 1px solid var(--neon); 
            padding: 5px 10px; border-radius: 5px; font-size: 0.6rem; font-weight: bold; cursor: pointer;
        }
        .small-btn:active { background: var(--neon); color: var(--dark); } /* Click Feedback Fix */

        .name-tag { position: absolute; bottom: 8px; left: 10px; background: rgba(0, 0, 0, 0.7); padding: 2px 10px; border-radius: 10px; font-size: 0.65rem; border: 1px solid var(--neon); color: #fff; z-index: 10; }

        .bottom-controls { 
            position: fixed; bottom: 20px; display: flex; gap: 15px; 
            background: rgba(10, 25, 47, 0.8); padding: 12px 25px; border-radius: 40px;
            backdrop-filter: blur(15px); border: 1px solid var(--neon); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .btn-orb { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-orb:active { transform: scale(0.9); border-color: var(--neon); }
        .btn-orb.red { background: rgba(239, 68, 68, 0.15); border-color: #ff4444; color: #ff4444; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="background"><div class="grid-lines"></div></div>
    <div class="shiny-title">LEO CONNECT PRO</div>

    <div id="lobby">
        <div class="glass-card">
            <h3 style="margin:0 0 20px 0; font-weight:400; font-size: 0.9rem; letter-spacing:1px;">HUB ACCESS</h3>
            <input type="text" id="nickname" placeholder="Commander Name">
            <input type="text" id="roomid" placeholder="Secure Room ID">
            <button class="btn-join" onclick="initCall()">AUTHORIZE & JOIN</button>
        </div>
    </div>

    <div id="call-room">
        <div id="video-grid">
            <!-- Video Containers will be added here -->
        </div>

        <div class="bottom-controls">
            <button class="btn-orb" id="micBtn" onclick="toggleMic()">ðŸŽ¤</button>
            <button class="btn-orb" onclick="location.reload()">ðŸ“ž</button>
            <button class="btn-orb red" onclick="dismissAll()" title="End Session">ðŸš«</button>
        </div>
    </div>

    <script>
        const socket = io();
        const videoGrid = document.getElementById('video-grid');
        let myStream, pcList = {}, myNickname, myRoom;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let controlTimeout;

        function updateGridStyles() {
            const count = videoGrid.children.length;
            let templateColumns = '1fr';
            let templateRows = '1fr';

            if (count === 1) {
                templateRows = '1fr';
            } else if (count === 2) {
                templateRows = '1fr 1fr';
            } else if (count === 3) {
                // Top 1, Bottom 2
                templateColumns = '1fr 1fr';
                templateRows = '2fr 1fr 1fr'; 
                // Special: First item takes 2 rows
            } else if (count >= 4) {
                templateColumns = '1fr 1fr';
                templateRows = '1fr 1fr';
            }
            
            videoGrid.style.gridTemplateColumns = templateColumns;
            videoGrid.style.gridTemplateRows = templateRows;
        }

        const resizeObserver = new ResizeObserver(updateGridStyles);
        resizeObserver.observe(videoGrid);

        async function initCall() {
            myNickname = document.getElementById('nickname').value;
            myRoom = document.getElementById('roomid').value;
            if(!myNickname || !myRoom) return alert("Fill Authorization!");

            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('call-room').style.display = 'flex';

            myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
            
            addVideoToGrid('local', myStream, myNickname + ' (You)', true);

            socket.emit('join-room', { roomId: myRoom, nickname: myNickname });
            socket.on('user-joined', (data) => sendOffer(data.id));
            socket.on('signal', (data) => handleSignal(data));
            socket.on('room-dismissed', () => { alert("Hub Closed"); location.reload(); });
            socket.on('user-left', (id) => { 
                if(pcList[id]) { 
                    pcList[id].close(); 
                    document.getElementById(id)?.remove(); 
                    delete pcList[id];
                    updateGridStyles();
                } 
            });
        }
        
        function addVideoToGrid(id, stream, name, isLocal) {
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = id;
            container.onclick = function() { toggleOrbControls(this); };

            let controlsHTML = '';
            if (isLocal) {
                controlsHTML = `
                    <div class="vid-controls">
                        <button class="small-btn" onclick="switchCamera('user')">FRONT CAM</button>
                        <button class="small-btn" onclick="switchCamera('environment')">BACK CAM</button>
                    </div>
                `;
            }

            container.innerHTML = `
                ${controlsHTML}
                <video id="${id}Video" autoplay playsinline ${isLocal ? 'muted' : ''}></video>
                <div class="name-tag">${name}</div>
            `;
            container.querySelector('video').srcObject = stream;
            videoGrid.appendChild(container);
            updateGridStyles();

            // Special layout for 3 users (Big Speaker)
            if (videoGrid.children.length === 3) {
                videoGrid.style.gridTemplateColumns = '1fr 1fr';
                videoGrid.style.gridTemplateRows = '1fr 1fr';
                document.getElementById('local').style.gridColumn = '1 / 3'; // Local video takes 2 columns
            } else if (videoGrid.children.length === 4) {
                 document.getElementById('local').style.gridColumn = 'auto';
            }
        }

        function toggleOrbControls(el) {
            const controls = el.querySelector('.vid-controls');
            if (!controls) return; // Only local has controls
            if (controlTimeout) clearTimeout(controlTimeout);
            controls.classList.add('show');
            controlTimeout = setTimeout(() => { controls.classList.remove('show'); }, 3000);
        }

        async function switchCamera(mode) {
            if(myStream) myStream.getTracks().forEach(t => t.stop());
            
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode }, audio: true });
                const newVT = newStream.getVideoTracks()[0];
                const newAT = newStream.getAudioTracks()[0];
                const isMuted = !myStream.getAudioTracks()[0].enabled;
                
                document.getElementById('localVideo').srcObject = newStream;

                for(let id in pcList) {
                    const senders = pcList[id].getSenders();
                    const vSender = senders.find(s => s.track && s.track.kind === 'video');
                    const aSender = senders.find(s => s.track && s.track.kind === 'audio');
                    if(vSender) await vSender.replaceTrack(newVT);
                    if(aSender) await aSender.replaceTrack(newAT);
                }

                newStream.getAudioTracks()[0].enabled = !isMuted;
                myStream = newStream;
            } catch(e) { alert("Camera Busy"); }
        }

        function toggleMic() {
            const at = myStream.getAudioTracks()[0];
            at.enabled = !at.enabled;
            const btn = document.getElementById('micBtn');
            btn.innerText = at.enabled ? 'ðŸŽ¤' : 'ðŸ”‡';
            btn.style.color = at.enabled ? '' : '#ff4444';
        }

        function createPC(toId) {
            const pc = new RTCPeerConnection(config);
            pcList[toId] = pc;
            myStream.getTracks().forEach(track => pc.addTrack(track, myStream));
            pc.onicecandidate = (e) => { if(e.candidate) socket.emit('signal', { to: toId, signal: { candidate: e.candidate } }); };
            pc.ontrack = (e) => addVideoToGrid(toId, e.streams[0], "Guest", false);
            return pc;
        }

        async function sendOffer(toId) {
            const pc = createPC(toId);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('signal', { to: toId, signal: { sdp: offer }, nickname: myNickname });
        }

        async function handleSignal(data) {
            let pc = pcList[data.from] || createPC(data.from);
            if(data.signal.sdp) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
                if(data.signal.sdp.type === 'offer') {
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    socket.emit('signal', { to: data.from, signal: { sdp: answer }, nickname: myNickname });
                }
                if(data.nickname) updateNameTag(data.from, data.nickname);
            } else if(data.signal.candidate) pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
        }

        function updateNameTag(id, name) {
            const container = document.getElementById(id);
            if(container) container.querySelector('.name-tag').innerText = name;
        }

        function dismissAll() { if(confirm("Terminate Hub?")) socket.emit('dismiss-room', myRoom); }
    </script>
</body>
</html>
