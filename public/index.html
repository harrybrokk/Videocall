<!DOCTYPE html>
<html lang="en">
<head>
    <title>LEO CONNECT - LIQUID GLASS PRO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { 
            --neon: #00f2ff; 
            --glass: rgba(255, 255, 255, 0.08); 
            --bg: #010409; 
            --glow: 0 0 20px rgba(0, 242, 255, 0.3);
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            color: #fff; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            align-items: center;
        }

        /* HOLOGRID BACKGROUND */
        .background { position: fixed; inset: 0; background: radial-gradient(circle at center, #0a192f 0%, #010409 100%); z-index: -1; }
        .grid-lines {
            position: absolute; width: 200%; height: 200%;
            background-image: linear-gradient(var(--glass) 1px, transparent 1px), linear-gradient(90deg, var(--glass) 1px, transparent 1px);
            background-size: 50px 50px; transform: perspective(500px) rotateX(60deg);
            top: -50%; left: -50%; animation: moveGrid 15s linear infinite; opacity: 0.2;
        }
        @keyframes moveGrid { from { transform: perspective(500px) rotateX(60deg) translateY(0); } to { transform: perspective(500px) rotateX(60deg) translateY(50px); } }

        /* SHINY METALLIC TITLE */
        .shiny-title {
            font-size: 1.6rem; font-weight: 900; text-align: center;
            background: linear-gradient(to right, #00f2ff, #fff, #00f2ff);
            background-size: 200% auto; -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; animation: shine 4s linear infinite;
            letter-spacing: 3px; margin-top: 15px; z-index: 10;
        }
        @keyframes shine { to { background-position: 200% center; } }

        /* LOBBY UI */
        #lobby { display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; z-index: 10; }
        .glass-card { 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); padding: 35px; border-radius: 30px;
            text-align: center; width: 85%; max-width: 360px; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
        }
        input { 
            width: 100%; padding: 14px; margin: 10px 0; background: rgba(0,0,0,0.5); 
            border: 1px solid #1e3a8a; border-radius: 12px; color: #fff; outline: none; transition: 0.3s;
        }
        input:focus { border-color: var(--neon); }
        .btn-join { 
            width: 100%; padding: 16px; margin-top: 20px; background: var(--neon);
            color: #000; border: none; border-radius: 50px; font-weight: 800; cursor: pointer;
            box-shadow: var(--glow); transition: 0.3s;
        }

        /* CIRCULAR VIDEO GRID */
        #call-room { display: none; width: 100%; height: 100%; padding: 20px; flex-direction: column; align-items: center; z-index: 5; }
        #video-grid { 
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            gap: 20px; width: 100%; height: 70vh; margin-top: 10px;
        }
        
        .video-container { 
            position: relative; width: 160px; height: 160px; border-radius: 50%;
            background: #111; border: 2px solid var(--neon);
            box-shadow: var(--glow); overflow: hidden; 
            transition: 0.4s ease; cursor: pointer;
        }
        .video-container.large { width: 200px; height: 200px; border-width: 3px; }
        
        /* FULL IMAGE FIX */
        video { width: 100%; height: 100%; object-fit: cover; transform: scale(1.15); }
        
        .name-tag { 
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);
            padding: 2px 12px; border-radius: 15px; font-size: 0.65rem;
            border: 1px solid var(--neon); color: #fff; z-index: 20;
        }

        /* AUTO-HIDE ORB CONTROLS */
        .orb-ctrls { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s ease; z-index: 15; pointer-events: none;
        }
        .orb-ctrls.show { opacity: 1; pointer-events: auto; }
        .mini-btn { 
            background: var(--neon); color: #000; border: none; padding: 6px 14px; 
            border-radius: 20px; font-size: 0.65rem; font-weight: 800; margin: 4px; cursor: pointer;
            box-shadow: 0 0 10px rgba(0,242,255,0.5);
        }

        /* COMMAND DOCK */
        .controls { 
            position: fixed; bottom: 30px; display: flex; gap: 15px; 
            background: rgba(10, 25, 47, 0.8); padding: 12px 25px; border-radius: 50px;
            backdrop-filter: blur(15px); border: 1px solid var(--neon); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .btn-orb { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: #fff; width: 50px; height: 50px; border-radius: 50%; 
            cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: 0.2s;
        }
        .btn-orb:active { transform: scale(0.9); border-color: var(--neon); }
        .btn-orb.red { background: rgba(239, 68, 68, 0.15); border-color: #ef4444; color: #ef4444; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="background"><div class="grid-lines"></div></div>
    <div class="shiny-title">LEO CONNECT PRO</div>

    <!-- Lobby Section -->
    <div id="lobby">
        <div class="glass-card">
            <h3 style="margin:0 0 20px 0; font-weight:400; font-size: 0.9rem; letter-spacing:1px;">COMMAND HUB ACCESS</h3>
            <input type="text" id="nickname" placeholder="Commander Nickname">
            <input type="text" id="roomid" placeholder="Secure Room ID">
            <button class="btn-join" onclick="initCall()">AUTHORIZE & JOIN</button>
        </div>
    </div>

    <!-- Call Room Section -->
    <div id="call-room">
        <div id="video-grid">
            <!-- Local User Orb -->
            <div class="video-container large" onclick="toggleOrbControls(this)">
                <div class="orb-ctrls">
                    <button class="mini-btn" onclick="switchCamera('user')">FRONT CAM</button>
                    <button class="mini-btn" onclick="switchCamera('environment')">BACK CAM</button>
                </div>
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="name-tag" id="myTag">You</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-orb" id="micBtn" onclick="toggleMic()">ðŸŽ¤</button>
            <button class="btn-orb" onclick="location.reload()">ðŸ“ž</button>
            <button class="btn-orb red" onclick="dismissAll()" title="End Session">ðŸš«</button>
        </div>
    </div>

    <script>
        const socket = io();
        let myStream, pcList = {}, myNickname, myRoom;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        async function initCall() {
            myNickname = document.getElementById('nickname').value;
            myRoom = document.getElementById('roomid').value;
            if(!myNickname || !myRoom) return alert("Fill Authorization!");

            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('call-room').style.display = 'flex';
            document.getElementById('myTag').innerText = myNickname;

            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
                document.getElementById('localVideo').srcObject = myStream;

                socket.emit('join-room', { roomId: myRoom, nickname: myNickname });
                socket.on('user-joined', (data) => sendOffer(data.id));
                socket.on('signal', (data) => handleSignal(data));
                socket.on('room-dismissed', () => { alert("Hub Closed"); location.reload(); });
                socket.on('user-left', (id) => { if(pcList[id]) { pcList[id].close(); document.getElementById(id)?.remove(); delete pcList[id]; } });
            } catch (err) { alert("Hardware Denied"); }
        }

        // --- ORB UI LOGIC ---
        function toggleOrbControls(el) {
            const controls = el.querySelector('.orb-ctrls');
            controls.classList.add('show');
            // Auto hide after 3 seconds
            setTimeout(() => { controls.classList.remove('show'); }, 3000);
        }

        // --- CAMERA SWITCH FIX ---
        async function switchCamera(mode) {
            // Stop old hardware first to avoid NotReadableError
            if(myStream) myStream.getTracks().forEach(t => t.stop());
            
            try {
                const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode }, audio: true });
                document.getElementById('localVideo').srcObject = newStream;
                const newVT = newStream.getVideoTracks()[0];
                
                for(let id in pcList) {
                    const senders = pcList[id].getSenders();
                    const vSender = senders.find(s => s.track && s.track.kind === 'video');
                    if(vSender) await vSender.replaceTrack(newVT);
                }
                myStream = newStream;
            } catch(e) { alert("Camera Busy"); }
        }

        function toggleMic() {
            const at = myStream.getAudioTracks()[0];
            at.enabled = !at.enabled;
            const btn = document.getElementById('micBtn');
            btn.innerText = at.enabled ? 'ðŸŽ¤' : 'ðŸ”‡';
            btn.style.color = at.enabled ? '' : '#ef4444';
        }

        // --- WebRTC Core ---
        function createPC(toId) {
            const pc = new RTCPeerConnection(config);
            pcList[toId] = pc;
            myStream.getTracks().forEach(track => pc.addTrack(track, myStream));
            pc.onicecandidate = (e) => { if(e.candidate) socket.emit('signal', { to: toId, signal: { candidate: e.candidate } }); };
            pc.ontrack = (e) => showRemoteVideo(toId, e.streams[0]);
            return pc;
        }

        async function sendOffer(toId) {
            const pc = createPC(toId);
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('signal', { to: toId, signal: { sdp: offer }, nickname: myNickname });
        }

        async function handleSignal(data) {
            let pc = pcList[data.from] || createPC(data.from);
            if(data.signal.sdp) {
                await pc.setRemoteDescription(new RTCSessionDescription(data.signal.sdp));
                if(data.signal.sdp.type === 'offer') {
                    const ans = await pc.createAnswer();
                    await pc.setLocalDescription(ans);
                    socket.emit('signal', { to: data.from, signal: { sdp: ans }, nickname: myNickname });
                }
                if(data.nickname) updateRemoteTag(data.from, data.nickname);
            } else if(data.signal.candidate) pc.addIceCandidate(new RTCIceCandidate(data.signal.candidate));
        }

        function showRemoteVideo(id, stream) {
            if(document.getElementById(id)) return;
            const div = document.createElement('div'); 
            div.className = 'video-container'; 
            div.id = id;
            div.onclick = function() { toggleOrbControls(this); };
            const v = document.createElement('video'); v.srcObject = stream; v.autoplay = true; v.playsInline = true;
            const tag = document.createElement('div'); tag.className = 'name-tag'; tag.innerText = "Guest";
            div.append(v, tag); document.getElementById('video-grid').appendChild(div);
        }

        function updateRemoteTag(id, name) {
            const container = document.getElementById(id);
            if(container) container.querySelector('.name-tag').innerText = name;
        }

        function dismissAll() { if(confirm("Terminate Hub?")) socket.emit('dismiss-room', myRoom); }
    </script>
</body>
</html>
